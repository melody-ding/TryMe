#!/bin/bash
set -Eeuo pipefail

js_path="$( cd "$( dirname "${BASH_SOURCE[0]}" )/.." && pwd )"
cd $js_path

wasm_js=src/ElvCryptoWasm.js
if [ -f $wasm_js ]; then
  echo Replacing $wasm_js
fi
cp ../dist/emscripten/lib/elv-crypto.js $wasm_js

wasm=src/ElvCrypto.wasm
if [ -f $wasm ]; then
  echo Replacing $wasm
fi
cp ../dist/emscripten/lib/elv-crypto.wasm $wasm

encoded_wasm=src/ElvCrypto.wasm.base64
if [ -f $encoded_wasm ]; then
  echo Replacing $encoded_wasm
fi
if [[ "$OSTYPE" == "darwin"* ]]; then
  base64 -i $wasm -o $encoded_wasm
else # "$OSTYPE" == "linux-gnu"
  base64 --wrap=0 $wasm > $encoded_wasm
fi

# Embed ElvCrypto.wasm into Assets.js
assets=src/Assets.js
if [ -f $assets ]; then
  echo Replacing $assets
fi
awk 'NR == FNR { file1 = (NR > 1 ? file1 RS : "") $0; next } \
{ gsub(/@ElvCrypto\.wasm@/, file1) } 1' \
$encoded_wasm src/Assets.in.js > $assets
